trigger:
  branches:
    include:
      - main
      - feature/*
  paths:
    include:
      - terraform/*

variables:
  - group: terraform-secrets

stages:

# ------------------- VALIDATE STAGE -------------------

- stage: Validate
  jobs:
    - job: terraform_validate
      displayName: 'Terraform Validate'
      pool:
        vmImage: 'ubuntu-latest'
      steps:

        - checkout: self

        - task: TerraformInstaller@1
          inputs:
            terraformVersion: '1.6.6'

        - script: terraform -version
          displayName: 'Terraform Version'

        - script: ls -al $(System.DefaultWorkingDirectory)/terraform/dev
          displayName: 'List contents of terraform/dev'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/dev'
            backendServiceArm: 'TerraformServiceConnection'
            backendAzureRmResourceGroupName: 'AZ-104'
            backendAzureRmStorageAccountName: 'glowsatf'
            backendAzureRmContainerName: 'sacont'
            backendAzureRmKey: 'dev.tfstate'

        - task: TerraformTaskV4@4
          displayName: 'Terraform Validate'
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/dev'

# ------------------- DEV DEPLOY -------------------

- stage: Dev_Deploy
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
    - deployment: terraform_apply_dev
      displayName: 'Terraform Apply Dev'
      environment: dev
      pool:
        vmImage: 'ubuntu-latest'
      strategy:
        runOnce:
          deploy:
            steps:

              - checkout: self

              - task: TerraformInstaller@1
                inputs:
                  terraformVersion: '1.6.6'

              - task: TerraformTaskV4@4
                displayName: 'Terraform Apply Dev'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/dev'
                  environmentServiceNameAzureRM: 'TerraformServiceConnection'

# ------------------- TEST DEPLOY -------------------

- stage: Test_Deploy
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
    - deployment: terraform_apply_test
      displayName: 'Terraform Apply Test'
      environment: test
      pool:
        vmImage: 'ubuntu-latest'
      strategy:
        runOnce:
          deploy:
            steps:

              - checkout: self

              - task: TerraformInstaller@1
                inputs:
                  terraformVersion: '1.6.6'

              - task: TerraformTaskV4@4
                displayName: 'Terraform Apply Test'
                inputs:
                  provider: 'azurerm'
                  command: 'apply'
                  workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/test'
                  environmentServiceNameAzureRM: 'TerraformServiceConnection'
